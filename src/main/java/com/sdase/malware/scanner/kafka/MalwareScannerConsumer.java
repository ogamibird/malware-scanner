package com.sdase.malware.scanner.kafka;

import com.sdase.malware.scanner.model.CheckRequestMessage;
import com.sdase.malware.scanner.model.CheckResult;
import com.sdase.malware.scanner.scanning.MalwareScannerService;
import lombok.AllArgsConstructor;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@AllArgsConstructor
public class MalwareScannerConsumer {

    private final MalwareScannerService malwareScannerService;
    private final MalwareScannerProducer malwareScannerProducer;

    @KafkaListener(topics = "scanRequests")
    public void listen(CheckRequestMessage requestMessage, @Header(CheckRequestMessage.HEADER_REQUESTER_SERVICE) String requestService, @Header(CheckRequestMessage.HEADER_CORRELATION_ID) String correlationId) {
        List<CheckResult> checkResults = malwareScannerService.scanFile(requestMessage.getCheckRequest());
        malwareScannerProducer.sendCheckResponse(checkResults, requestService, correlationId);
    }
}
